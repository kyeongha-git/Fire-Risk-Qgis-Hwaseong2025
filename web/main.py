# -*- coding: utf-8 -*-
#!/usr/bin/env python
# coding: utf-8

# # leafmap, streamlit, folium ì—…ê·¸ë ˆì´ë“œ

# # ì›¹ì‚¬ì´íŠ¸ êµ¬í˜„ (main.py)

# In[1]:


with open("app.py", "w", encoding = "utf-8") as f : 
    f.write('''from folium.features import JsCode\nimport streamlit as st\nimport folium\nimport geopandas as gpd\nfrom folium.features import DivIcon\nfrom streamlit_folium import st_folium\nimport json\nimport pandas as pd\nfrom openai import OpenAI\n\nst.set_page_config(\n    page_title="ì‚°ì—…ë‹¨ì§€ í™”ì¬ ìœ„í—˜ë„ ë§µ",\n    page_icon="ğŸ”¥",\n    layout="wide",\n    initial_sidebar_state="expanded"\n)\n\n# --- OpenAI API í‚¤ ì§ì ‘ ì…ë ¥ ë° í´ë¼ì´ì–¸íŠ¸ ìƒì„± ---\nclient = OpenAI(api_key="my_key")  # â† ë³¸ì¸ í‚¤ ì…ë ¥\n\n# ---- ì‚°ì—…ë‹¨ì§€ ë° íŒŒì¼ ë§¤í•‘ ----\nindustrial_areas = {\n    "ë°œì•ˆì¼ë°˜ì‚°ì—…ë‹¨ì§€": {\n        "geojson": "Data/ë°œì•ˆì‚°ì—…ë‹¨ì§€_ìµœì¢…ìŠ¤ì½”ì–´ë§_ê²°ê³¼.geojson",\n        "csv": "Data/á„‡á…¡á†¯á„‹á…¡á†«á„‰á…¡á†«á„‹á…¥á†¸á„ƒá…¡á†«á„Œá…µ.csv",\n        "buffer_geojson": "Data/á„‡á…¡á†¯á„‹á…¡á†«_á„Œá…¦á†¯á„‹á…±á„’á…¥á†·_á„‡á…¥á„‘á…¥600.geojson"\n    },\n    "í–¥ë‚¨ì œì•½ì¼ë°˜ì‚°ì—…ë‹¨ì§€": {\n        "geojson": "Data/í–¥ë‚¨ì‚°ì—…ë‹¨ì§€_ìµœì¢…ìŠ¤ì½”ì–´ë§_ê²°ê³¼.geojson",\n        "csv": "Data/á„’á…£á†¼á„‚á…¡á†·á„Œá…¦á„‹á…£á†¨á„‰á…¡á†«á„‹á…¥á†¸á„ƒá…¡á†«á„Œá…µ111.csv",\n        "buffer_geojson": "Data/á„’á…£á†¼á„‚á…¡á†·_á„Œá…¦á†¯á„‹á…±á„’á…¥á†·_á„‡á…¥á„‘á…¥600.geojson"\n    },\n    "ë™íƒ„ë„ì‹œì²¨ë‹¨ì‚°ì—…ë‹¨ì§€": {\n        "geojson": "Data/ë™íƒ„ë„ì‹œì²¨ë‹¨ì‚°ì—…ë‹¨ì§€_á„á…¬á„Œá…©á†¼á„‰á…³á„á…©á„‹á…¥á„…á…µá†¼_á„€á…§á†¯á„€á…ª.geojson",\n        "csv": "Data/á„ƒá…©á†¼á„á…¡á†«á„ƒá…©á„‰á…µá„á…¥á†·á„ƒá…¡á†«á„‰á…¡á†«á„‹á…¥á†¸á„ƒá…¡á†«á„Œá…µ111.csv",\n        "buffer_geojson": "Data/ë™á„ƒá…©á„á…¥á†·_á„Œá…¦á†¯á„‹á…±á„’á…¥á†·_á„‡á…¥á„‘á…¥600.geojson"\n    }\n}\n\n# ---- ChatGPT ì‚°ì—…ë‹¨ì§€ ìš”ì•½ í•¨ìˆ˜ (ìºì‹± ì ìš©) ----\n@st.cache_data(show_spinner=False)\ndef get_area_summary_cached(area_name, csv_path):\n    try:\n        df = pd.read_csv(csv_path, encoding="utf-8")\n        sample = df.to_string(index=False)\n        prompt = f"""\në‹¹ì‹ ì€ ì‚°ì—…ë‹¨ì§€ì˜ ìœ„í—˜ë„ë¥¼ ë¶„ì„í•˜ëŠ” ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.\n\nì•„ë˜ëŠ” {area_name}ì˜ í™”ì¬ ìœ„í—˜ìš”ì¸ ë°ì´í„°ì…ë‹ˆë‹¤. ì´ëŠ” ê° êµ¬ì—­ë³„ë¡œ idê°€ ìˆìœ¼ë©°, í™”ì¬ ìœ„í—˜ ìš”ì¸ featureë³„ í™”ì¬ ìœ„í—˜ ìˆ˜ì¤€ ê°’ì´ ìˆìŠµë‹ˆë‹¤.\n{sample}\n\nìœ„ ë°ì´í„°ì˜ featureëŠ” í™”ì¬ ìœ„í—˜ë„ë¥¼ í‰ê°€í•˜ëŠ” ìš”ì†Œì´ë©°, ê°’ì€ featureì˜ ê°œìˆ˜ê°€ ì•„ë‹Œ í™”ì¬ ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì´ëŠ” ìˆ«ìê°€ ë†’ì„ìˆ˜ë¡ ìœ„í—˜í•˜ë©°, ë‚®ì„ ìˆ˜ë¡ ì•ˆì „í•©ë‹ˆë‹¤.\n\nìš°ë¦¬ì—ê²ŒëŠ” ì„¸ ê°€ì§€ ì˜ˆì‚° ë³„ ëŒ€ì±…ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\nì €ì˜ˆì‚°ì€ ê¸°ë³¸ êµìœ¡, ì†Œë°©ì‹œì„¤ ì ê²€, í˜„ì¥ ì»¨ì„¤íŒ…ì´ ê¸°ë³¸ì ì¸ ë°©ì•ˆì´ë©° ìš°ë¦¬ê°€ ì œì•ˆí•˜ê³ ì í•˜ëŠ” ë°©ì•ˆì€ AI CCTV ì„¤ì¹˜, í™”ì¬ ì•Œë¦¼ ê²½ë³´ ì‹œìŠ¤í…œì´ê³  ì ìš© ì˜ˆì‹œë¡œëŠ” ì†Œê·œëª¨ ê³µì¥, ì·¨ì•½ì‚¬ì—…ì¥ ì¤‘ì‹¬ì— ì ìš©í•˜ëŠ” ê²ƒì´ ìˆìŠµë‹ˆë‹¤.\nì¤‘ê°„ ì˜ˆì‚°ìœ¼ë¡œëŠ” ìœ„í—˜ìš”ì¸ ì‹ë³„, ì†Œë°© í›ˆë ¨, ìš©ìˆ˜ì‹œì„¤ í™•ì¶©, ì˜ˆë°©ê°•í™”ì§€êµ¬ ì§€ì •ì´ ê¸°ë³¸ì ì¸ ë°©ì•ˆì´ë©° ìš°ë¦¬ê°€ ì œì•ˆí•˜ê³ ì í•˜ëŠ” ë°©ì•ˆì€ í™”ì¬ ì˜ˆì¸¡ ëª¨ë¸ ë„ì…, AI ê¸°ë°˜ ì‹¤ì‹œê°„ í™”ì¬ ê°ì§€ê°€ ìˆê³  ì ìš© ì˜ˆì‹œë¡œëŠ” í‘œì¤€ ì‚°ì—…ë‹¨ì§€, ì—…ì¢…ë³„ ë§ì¶¤ ê´€ë¦¬ê°€ ìˆìŠµë‹ˆë‹¤.\nê³ ì˜ˆì‚°ìœ¼ë¡œëŠ” ì²¨ë‹¨ì˜ˆì¸¡&ëŒ€ì‘, ëŒ€ê·œëª¨ ì¸í”„ë¼, í†µí•©ê´€ì œ, íŠ¹ìˆ˜ì‹œì„¤ êµ¬ì¶•ì´ ê¸°ë³¸ì ì¸ ë°©ì•ˆì´ë©° ìš°ë¦¬ê°€ ì œì•ˆí•˜ê³ ì í•˜ëŠ” ë°©ì•ˆì€ AI í†µí•© í™”ì¬ ëª¨ë‹ˆí„°ë§ ì„¼í„° êµ¬ì¶•, ìŠ¤ë§ˆíŠ¸ í™”ì¬ëŒ€ì‘ í”Œë«í¼ì´ ìˆê³  ì ìš© ì˜ˆì‹œë¡œëŠ” êµ­ê°€ì‚°ë‹¨, ëŒ€í˜•í™”ì¬ ë° ë³µí•©ì¬ë‚œ ëŒ€ì‘ì´ ìˆìŠµë‹ˆë‹¤.\n\në”°ë¼ì„œ, ìš°ë¦¬ëŠ” í•´ë‹¹ ì‚°ì—…ë‹¨ì§€ê°€ ì¢…í•©ì ìœ¼ë¡œ ì–´ëŠì •ë„ í™”ì¬ ìœ„í—˜ë„ë¥¼ ê°€ì§€ëŠ”ì§€ íŒë³„í•˜ì—¬ í•´ë‹¹ ì‚°ì—…ë‹¨ì§€ì— ì˜ˆì‚° íˆ¬ì… ìˆ˜ì¤€ì„ íŒë‹¨í•˜ê³  ëŒ€ì‘ ë°©ì•ˆì„ ì œì•ˆí•©ë‹ˆë‹¤.\n1. {area_name}ì˜ í™”ì¬ ìœ„í—˜ìš”ì¸ê³¼ ë°©ì¬ ì·¨ì•½ ìš”ì†Œë¥¼ íŒë‹¨í•˜ê³  ì œì‹œí•©ë‹ˆë‹¤.\n2. ì–´ë–¤ ì˜ˆì‚° ë„ì… (ì €/ì¤‘/ê³ )ì´ í•„ìš”í•œì§€ íŒë³„ í›„ ìœ„ ëŒ€ì‘ì±…ê³¼ ë§¤ì¹˜í•˜ì—¬ AI/ìŠ¤ë§ˆíŠ¸ ëŒ€ì‘ë°©ì•ˆ ë° ì ìš© ì˜ˆì‹œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤. \nê° ê²°ê³¼ëŠ” ì „ë¬¸ì„±ì´ ìˆëŠ” ê¸€ì´ì–´ì•¼ í•˜ë©°, íŒë‹¨ ì´ìœ ê°€ íƒ€ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤. ê° ê²°ê³¼ëŠ” 1~2ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n\nì˜ˆì‹œ) ë°œì•ˆì‚°ì—…ë‹¨ì§€ë¥¼ ë¶„ì„í•œë‹¤. -> ìš°ë¦¬ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì—¬ ë¶„ì„ ìš”ì•½ ë° ìœ„í—˜ ìš”ì¸ê³¼ ë°©ì¬ ì·¨ì•½ ìš”ì†Œ íŒŒì•… í›„, ì–´ë–¤ ìˆ˜ì¤€ì˜ ëŒ€ì‘ì´ í•„ìš”í•œì§€ ì„¤ëª… ë° ëŒ€ì‘ ë°©ì•ˆ ì œì‹œ.\nğŸ”¶ ë°œì•ˆì‚°ì—…ë‹¨ì§€\në¶„ì„ ìš”ì•½: ìœ„í—˜ë¬¼ ì·¨ê¸‰ ì‹œì„¤, ê³ ë°€ë„ ê±´ë¬¼ ë“±ì´ ë‹¤ìˆ˜ ì¡´ì¬í•˜ë©°, ì†Œë°©ì°¨ ì ‘ê·¼ì„±ê³¼ ì†Œë°©ì„œ ê±°ë¦¬ ë“± ë°©ì¬ ì—¬ê±´ì´ ë§¤ìš° ì—´ì•…í•¨.\n\nìœ„í—˜ ìš”ì¸: ìœ„í—˜ë¬¼íšŒì‚¬ ë°€ì§‘, ê±´ë¬¼ë°€ë„ ë†’ìŒ\n\në°©ì¬ ì·¨ì•½ ìš”ì†Œ: ì†Œë°©ì°¨ ì ‘ê·¼ ë¶ˆê°€, ì†Œë°©ì„œ ì›ê±°ë¦¬\n\nì ìš© ëŒ€ì‘ì±…:\nğŸ‘‰ ì¤‘ê°„ ì˜ˆì‚° ìˆ˜ì¤€ ëŒ€ì‘ í•„ìš”\n\nì£¼ìš” ëŒ€ì±…: ìœ„í—˜ìš”ì¸ ì„ ë³„, ì†Œë°©í›ˆë ¨ ê°•í™”, ìš©ìˆ˜ì‹œì„¤ ì¶”ê°€\n\nAI ë°©ì•ˆ: í™”ì¬ ì˜ˆì¸¡ ëª¨ë¸ ë° ì‹¤ì‹œê°„ ê²½ê³  ì‹œìŠ¤í…œ\n\nì ìš© ì˜ˆì‹œ: í‘œì¤€ ì‚°ì—…ë‹¨ì§€ ì¤‘ ìœ„í—˜êµ¬ì—­ ìš°ì„  ì¡°ì¹˜\n"""\n        response = client.chat.completions.create(\n            model="gpt-4o-mini",\n            messages=[{"role": "user", "content": prompt}],\n            max_tokens=600,\n            temperature=0.7\n        )\n        summary = response.choices[0].message.content.strip()\n        return summary\n    except Exception as e:\n        return f"ìš”ì•½ ìƒì„± ì˜¤ë¥˜: {e}"\n\nwith st.sidebar:\n    st.header("ğŸ“‚ ì‚°ì—…ë‹¨ì§€ ì„ íƒ")\n    selected_area = st.selectbox("ì‚°ì—…ë‹¨ì§€", list(industrial_areas.keys()))\n    use_color = st.checkbox("í™”ì¬ ìœ„í—˜ë„ 5í´ë˜ìŠ¤ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸ í‘œì‹œ", value=True)\n    show_buffer = st.checkbox("ë²„í¼ ë¶„ì„ ë ˆì´ì–´ í‘œì‹œ", value=False)\n\n    legend_html = \'\'\'\n<div style="background-color: #222; color: #fff; border: 2px solid #444; border-radius: 8px; padding: 14px 14px 10px 14px; margin-bottom: 18px; margin-top:10px; font-size: 15px; font-weight: 500; letter-spacing: 0.5px;">\n<b style="color:#fff;">í™”ì¬ ìœ„í—˜ë„ ìƒ‰ìƒ ë²”ë¡€</b><br>\n<div style=\'background:#ffffff; color:#111; width: 20px; height: 20px; display: inline-block; border: 1px solid #999; margin-right: 8px; vertical-align:middle;\'></div> <span style="color:#fff;">ë§¤ìš° ë‚®ìŒ</span><br>\n<div style=\'background:#ffcccc; color:#111; width: 20px; height: 20px; display: inline-block; border: 1px solid #999; margin-right: 8px; vertical-align:middle;\'></div> <span style="color:#fff;">ë‚®ìŒ</span><br>\n<div style=\'background:#ff9999; color:#111; width: 20px; height: 20px; display: inline-block; border: 1px solid #999; margin-right: 8px; vertical-align:middle;\'></div> <span style="color:#fff;">ë³´í†µ</span><br>\n<div style=\'background:#ff6666; color:#111; width: 20px; height: 20px; display: inline-block; border: 1px solid #999; margin-right: 8px; vertical-align:middle;\'></div> <span style="color:#fff;">ë†’ìŒ</span><br>\n<div style=\'background:#ff0000; color:#fff; width: 20px; height: 20px; display: inline-block; border: 1px solid #999; margin-right: 8px; vertical-align:middle;\'></div> <span style="color:#fff;">ë§¤ìš° ë†’ìŒ</span>\n</div>\n\'\'\'\n    st.markdown(legend_html, unsafe_allow_html=True)\n    \n    st.markdown("---")\n    # ChatGPT ìë™ ìš”ì•½ ìƒì„± ë° ë°•ìŠ¤ í‘œì‹œ (ìºì‹œ í™œìš©)\n    with st.spinner(f"{selected_area} AI ìš”ì•½ ìƒì„± ì¤‘..."):\n        summary = get_area_summary_cached(selected_area, industrial_areas[selected_area]["csv"])\n    st.markdown(\n        f"""\n        <div style="background-color:#222; color:#fff; border-radius:10px; padding:16px; margin-top:10px; margin-bottom:10px;">\n        <b>ğŸ“‹ {selected_area} í™”ì¬ ìœ„í—˜ë„ ë¶„ì„ ë° ëŒ€ì‘ ë°©ì•ˆ</b><br>\n        {summary.replace(\'\\n\', \'<br>\')}\n        </div>\n        """,\n        unsafe_allow_html=True\n    )\n    st.markdown("---")\n    st.markdown("#### ğŸ–±ï¸ ì§€ë„ ì¡°ì‘ ì•ˆë‚´")\n    st.markdown("""\n- ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ  \n- ë“œë˜ê·¸ë¡œ ì´ë™  \n- ë²”ë¡€ì™€ ìˆ˜ì¹˜ëŠ” ìœ„í—˜ë„ ë“±ê¸‰ì…ë‹ˆë‹¤.\n""")\n    \ngeojson_path = industrial_areas[selected_area]["geojson"]\ncsv_path = industrial_areas[selected_area]["csv"]\nbuffer_geojson_path = industrial_areas[selected_area]["buffer_geojson"]\n\n# ---- GeoJSONì˜ ë§ˆì§€ë§‰ ì†ì„± ì—´ ì´ë¦„ ì¶”ì¶œ ----\nwith open(geojson_path, encoding="utf-8") as f:\n    gj = json.load(f)\n    property_keys = list(gj["features"][0]["properties"].keys())\n    last_property_col = property_keys[-1]\n\n# ---- ìƒ‰ìƒ ê¸°ì¤€ í•¨ìˆ˜ ----\ndef get_color_balan(value):\n    try: value = float(value)\n    except: return "#cccccc"\n    if -0.3 < value <= -0.15: return "#ffffff"\n    elif -0.15 < value <= 0.25: return "#ffcccc"\n    elif 0.25 < value <= 1.2: return "#ff9999"\n    elif 1.2 < value <= 1.95: return "#ff6666"\n    elif 1.95 < value <= 2.35: return "#ff0000"\n    else: return "#cccccc"\n\ndef get_color_hyangnam(value):\n    try: value = float(value)\n    except: return "#cccccc"\n    if 0.4 < value <= 0.4: return "#ffffff"\n    elif 0.4 < value <= 0.7: return "#ffcccc"\n    elif 0.7 < value <= 1.0: return "#ff9999"\n    elif 1.0 < value <= 2.3: return "#ff6666"\n    elif 2.3 < value <= 2.6: return "#ff0000"\n    else: return "#cccccc"\n\ndef get_color_dongtan(value):\n    try: value = float(value)\n    except: return "#cccccc"\n    if 0.0 < value <= 0.4: return "#ffffff"\n    elif 0.4 < value <= 1.25: return "#ff9999"\n    elif 1.25 < value <= 2.0: return "#ff6666"\n    elif 2.0 < value <= 2.3: return "#ff0000"\n    else: return "#cccccc"\n\nif selected_area == "ë°œì•ˆì¼ë°˜ì‚°ì—…ë‹¨ì§€":\n    get_color = get_color_balan\nelif selected_area == "í–¥ë‚¨ì œì•½ì¼ë°˜ì‚°ì—…ë‹¨ì§€":\n    get_color = get_color_hyangnam\nelif selected_area == "ë™íƒ„ë„ì‹œì²¨ë‹¨ì‚°ì—…ë‹¨ì§€":\n    get_color = get_color_dongtan\n\n# ---- ë©”ì¸ ë³¸ë¬¸ ----\nst.markdown("<h1 style=\'text-align:center; margin-bottom:1.5rem;\'>ğŸ“Š ì‚°ì—…ë‹¨ì§€ í™”ì¬ ìœ„í—˜ë„ ë§µ</h1>", unsafe_allow_html=True)\nst.markdown(f"""\n<div style=\'text-align:center; font-size:1.1rem; margin-bottom:1.5rem;\'>\nì„ íƒí•œ ì‚°ì—…ë‹¨ì§€ì˜ í™”ì¬ ìœ„í—˜ë„ ë“±ê¸‰ì„ ìœ„ì„±ì§€ë„ì™€ í•¨ê»˜ í•œëˆˆì— ì œê³µí•©ë‹ˆë‹¤.<br>\nìœ„í—˜ë„ ìˆ˜ì¹˜ëŠ” ê° êµ¬ì—­ë³„ë¡œ ì§€ë„ì— í‘œì‹œë˜ë©°, ë¶„ì„ ê²°ê³¼ëŠ” ì¢Œì¸¡ì—ì„œ í™•ì¸í•˜ì„¸ìš”.<br>\n</div>\n""", unsafe_allow_html=True)\n\n# ---- GeoJSON ë°ì´í„° ì½ê¸° ë° ì¢Œí‘œê³„ ë³€í™˜ ----\ntry:\n    gdf = gpd.read_file(geojson_path)\n    if gdf.crs is not None and gdf.crs.to_string() != "EPSG:4326":\n        gdf = gdf.to_crs(epsg=4326)\nexcept Exception as e:\n    st.error(f"GeoJSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")\n    st.stop()\n\ncenter = [gdf.geometry.centroid.y.mean(), gdf.geometry.centroid.x.mean()]\nm = folium.Map(location=center, zoom_start=11)\nfolium.TileLayer(\n    tiles="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",\n    attr="Tiles Â© Esri",\n    name="Esri World Imagery",\n    overlay=False,\n    control=True\n).add_to(m)\n\n# ---- ìŠ¤íƒ€ì¼ í•¨ìˆ˜ ----\ndef style_callback(feature):\n    value = feature["properties"].get(last_property_col)\n    try: value = float(value)\n    except: return {"color": "black", "weight": 1, "fillColor": "#cccccc", "fillOpacity": 0.1}\n    color = get_color(value)\n    return {"color": "black", "weight": 1, "fillColor": color, "fillOpacity": 0.7}\n\ndef no_style_callback(feature):\n    return {"color": "black", "weight": 1, "fillColor": "#cccccc", "fillOpacity": 0.4}\n\nstyle_func = style_callback if use_color else no_style_callback\n\nlayer = folium.GeoJson(\n    data=gdf.to_json(),\n    name="ì‚°ì—…ë‹¨ì§€ ìœ„í—˜ë„",\n    style_function=style_func,\n    tooltip=folium.GeoJsonTooltip(fields=[last_property_col], aliases=["ìœ„í—˜ë„:"], localize=True)\n).add_to(m)\nm.fit_bounds(layer.get_bounds())\n\n# ---- í…ìŠ¤íŠ¸ ë§ˆì»¤(ìœ„í—˜ë„ ìˆ˜ì¹˜)ëŠ” ìƒ‰ìƒ í‘œì‹œê°€ ì¼œì ¸ ìˆì„ ë•Œë§Œ ì¶”ê°€ ----\nif use_color:\n    for idx, row in gdf.iterrows():\n        value = row[last_property_col]\n        try:\n            value_disp = round(float(value), 2)\n        except:\n            value_disp = value\n        centroid = row["geometry"].centroid\n        icon = DivIcon(\n            icon_size=(60, 20),\n            icon_anchor=(30, 10),\n            html=f"<div style=\'font-size: 15pt; color: white; font-weight: bold; text-shadow: 2px 2px 4px black; z-index: 1000;\'>{value_disp}</div>"\n        )\n        folium.Marker(location=[centroid.y, centroid.x], icon=icon).add_to(m)\n\n# --- ë²„í¼ ë¶„ì„ ë ˆì´ì–´ ì¶”ê°€ (ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ) ---\nif show_buffer:\n    try:\n        buffer_gdf = gpd.read_file(buffer_geojson_path)\n        if buffer_gdf.crs is not None and buffer_gdf.crs.to_string() != "EPSG:4326":\n            buffer_gdf = buffer_gdf.to_crs(epsg=4326)\n        buffer_layer = folium.GeoJson(\n            data=buffer_gdf.to_json(),\n            name="ë²„í¼ ë¶„ì„",\n            style_function=lambda feature: {\n                "fillColor": "#3388ff",\n                "color": "#3388ff",\n                "weight": 2,\n                "fillOpacity": 0.2\n            },\n            tooltip=folium.GeoJsonTooltip(fields=[], aliases=[], localize=True)\n        )\n        buffer_layer.add_to(m)\n    except Exception as e:\n        st.error(f"ë²„í¼ ë¶„ì„ GeoJSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")\n\n# ---- folium LayerControl ì¶”ê°€ ----\nfolium.LayerControl().add_to(m)\n\n# --- GPT êµ¬ì—­ë³„ ìš”ì•½ ê¸°ëŠ¥ ---\ndf_csv = pd.read_csv(csv_path, encoding="utf-8")\n\noutput = st_folium(m, use_container_width=True, height=700)\n\nclicked_id = None\nif output and output.get("last_active_drawing"):\n    props = output["last_active_drawing"]["properties"]\n    clicked_id = props.get("id")\n\nif clicked_id is not None:\n    row = df_csv[df_csv["id"] == int(clicked_id)]\n    if not row.empty:\n        row = row.iloc[0]\n        prompt = f"""\n        ë‹¹ì‹ ì€ ì‚°ì—…ë‹¨ì§€ ë‚´ êµ¬ì—­ë³„ ìœ„í—˜ìš”ì¸ì„ ë³´ê³  ë¶„ì„í•˜ëŠ” ìœ ëŠ¥í•œ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.\n        ë‹¤ìŒì€ {selected_area} {clicked_id}ë²ˆ êµ¬ì—­ì˜ ìœ„í—˜ìš”ì¸ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.\n        - ìœ„í—˜ë¬¼íšŒì‚¬ê°œìˆ˜: {row[\'ìœ„í—˜ë¬¼íšŒì‚¬ê°œìˆ˜\']}\n        - ê±´ë¬¼ë°€ë„: {row[\'ê±´ë¬¼ë°€ë„\']}\n        - ë…¸í›„ê±´ë¬¼ë¹„ìœ¨: {row[\'ë…¸í›„ê±´ë¬¼ë¹„ìœ¨\']}\n        - ìœ„í—˜ì‹œì„¤ë¬¼: {row[\'ìœ„í—˜ì‹œì„¤ë¬¼\']}\n        - ì†Œë°©ì°¨ì ‘ê·¼ì„±: {row[\'ì†Œë°©ì°¨ì ‘ê·¼ì„±\']}\n        - ì†Œë°©ìš©ìˆ˜ì‹œì„¤: {row[\'ì†Œë°©ìš©ìˆ˜ì‹œì„¤\']}\n        - ì†Œë°©ì„œë°119ì•ˆì „ì„¼í„°: {row[\'ì†Œë°©ì„œë°119ì•ˆì „ì„¼í„°\']}\n        - ìµœì¢…ìŠ¤ì½”ì–´ë§(ìœ„í—˜ë„): {row[\'ìµœì¢…ìŠ¤ì½”ì–´ë§\']}\n\n        ìœ„ ìˆ˜ì¹˜ë“¤ì€ ê° êµ¬ì—­ë³„ ìœ„í—˜ë„ë¥¼ ì¸¡ì •í•  ë•Œ ì‚¬ìš©ëœ featureì™€ ìœ„í—˜ ìˆ˜ì¤€ ë¶„ë¥˜ ê²°ê³¼ì…ë‹ˆë‹¤.\n        ê° í´ë˜ìŠ¤ ë¶„ë¥˜ëŠ” 5ê°€ì§€ë¡œ ë‚˜ë‰˜ë©° 5ê°€ ê°€ì¥ í° (ê°€ì¥ ìœ„í—˜í•œ) ê°’ì´ê³ , 1ì´ ê°€ì¥ ì‘ì€ (ê°€ì¥ ì•ˆì „í•œ) ê°’ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n        ê°•ì¡°í•˜ì§€ë§Œ ì´ëŠ” ê°œìˆ˜ê°€ ì•„ë‹Œ ìœ„í—˜ ìˆ˜ì¤€ì…ë‹ˆë‹¤.\n        ê° featureì˜ íŠ¹ì„±ê³¼ í´ë˜ìŠ¤ ë¶„ë¥˜ ê°’ì„ ê³ ë ¤í•˜ì—¬ ê° êµ¬ì—­ë³„ ìœ„í—˜ë„ ë¶„ì„ì„ ì§„í–‰í•˜ë ¤ í•©ë‹ˆë‹¤.\n        ëª¨ë“  featureë¥¼ ê³ ë ¤í•œ ìµœì¢… ë¶„ì„ ê²°ê³¼ë¥¼ ì „ë¬¸ì„±ìˆê³  ì •í™•í•˜ê²Œ ì‘ì„±í•˜ë©°, 1~2 ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n        ì´ ë•Œ, ìƒì„±ë˜ëŠ” ìš”ì•½ë¬¸ì—ëŠ” ìˆ˜ì¹˜ë¥¼ ì œì‹œí•˜ì§€ë§ê³  ì´ì— ë”°ë¥¸ ê²°ê³¼ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´, ìœ„í—˜ ìˆ˜ì¤€ì´ 5ë¼ë©´ "ë§¤ìš° ë†’ìŒ", 4ëŠ” "ë†’ìŒ", 3ì€ "ë³´í†µ", 2ëŠ” "ë‚®ìŒ", 1ì€ "ë§¤ìš° ë‚®ìŒ"ì…ë‹ˆë‹¤.\n        ì¤‘ìš”í•œ íŠ¹ì„± (ìœ„í—˜ ìˆ˜ì¤€ì´ ë†’ì€)ì„ ë” ì§‘ì¤‘ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.\n        """\n        if st.button(f"ğŸ”¥ êµ¬ì—­ {clicked_id} í™”ì¬ ìœ„í—˜ë„ ìš”ì•½"):\n            with st.spinner(f"êµ¬ì—­ {clicked_id} AI ë¶„ì„ ê²°ê³¼ ìƒì„± ì¤‘..."):\n                response = client.chat.completions.create(\n                    model="gpt-4o-mini",\n                    messages=[{"role": "user", "content": prompt}],\n                    max_tokens=300,\n                    temperature=0.7\n                )\n                summary = response.choices[0].message.content.strip()\n            st.markdown("#### ğŸ“‹ í™”ì¬ ìœ„í—˜ë„ ìš”ì•½ ê²°ê³¼")\n            st.success(summary)\n    else:\n        st.info("CSVì—ì„œ í•´ë‹¹ êµ¬ì—­ì˜ ìœ„í—˜ìš”ì¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")\n''')


# # ngrok í† í° ê°€ì ¸ì˜¤ê¸°

# In[2]:

import os
os.system('ngrok config my_token')


# # ì„œë²„ ì‹¤í–‰

# In[3]:


from pyngrok import ngrok
import subprocess
import time
import requests

# 1. Streamlit ì‹¤í–‰ (Jupyter ì™¸ë¶€ì—ì„œ ì‹¤í–‰í•  ë•Œ)
subprocess.Popen(["streamlit", "run", "app.py", "--server.port=8502"])

# 2. ngrok ì—°ê²°
subprocess.Popen(["ngrok", "http", "8502"])

time.sleep(5)

# ngrok URL ê°€ì ¸ì˜¤ê¸°
try:
    res = requests.get("http://localhost:4040/api/tunnels")
    tunnels = res.json()["tunnels"]
    public_url = tunnels[0]["public_url"]
    print("âœ… ngrok URL:", public_url)
except Exception as e:
    print("âŒ ngrok URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", e)
